# -*- coding: utf-8 -*-
import os
from datetime import datetime
from ftplib import FTP

TargetDir = ["E:\\test", "E:\\test2"]
TargetFile = ["QuickFix.dll", "ZDTradeClient.exe", "CommonClassLib.dll", "FIX42.xml"]
Path = []
File = []


def scan_dir(targetdir):
    """
    用于读取出所有的通讯相应路径
    :param targetdir:通讯所在的文件路径
    :return:返回所有的通讯路径到变量列表Path内
    """
    for dir in targetdir:
        os.chdir(dir)
        for newroot, newdirs, newfiles in os.walk(dir, topdown=False):
            for newname in newfiles:
                if newname == "ZDTradeClient.exe":
                    Path.append(newroot)


def file_rename(path):
    """
    用于把指定路径下的CME通讯的指定文件进行重命名
    :param path: 通讯的路径
    :return: 无返回
    """
    for i in path:
        try:
            os.chdir(i)
            for newroot, newdirs, newfiles in os.walk(i):
                # 先判断是否有效的通讯路径
                if newdirs is not None:
                    for dir in newdirs:
                        if dir.lower() == 'config':
                            config = os.path.join(newroot, dir)
                            os.chdir(config)
                            for newroot1, newdirs1, newfiles1 in os.walk("."):
                                if newdirs1 is not None:
                                    for file1 in newfiles1:
                                        if file1 in (TargetFile):
                                            newname1 = datetime.now().strftime('%Y%m%d') + '_' + file1
                                            os.rename(os.path.join(newroot1, file1), os.path.join(newroot1, newname1))

                    for file in newfiles:
                        if file in (TargetFile):
                            newname2 = datetime.now().strftime('%Y%m%d') + '_' + file
                            os.rename(os.path.join(newroot, file), os.path.join(newroot, newname2))
        except IOError:
            print("{} 通讯程序名称修改失败".format(i))




def download_file(path,file_list):
    try:
        for file in file_list:
            if file.lower() == 'config':
                try:
                    ftp.cwd('config')
                    for fs in ftp.nlst():
                        with open(path + '\\config\\' + fs, 'wb') as f1:
                            filename = 'RETR ' + fs
                            ftp.retrbinary(filename, f1.write)
                            ftp.cwd('..')
                except IOError:
                    ftp.cwd('..')
                    print("Error:对 {} 下的config文件更新失败，请调查 ".format(path))
            else:
                try:
                    with open(path + '\\' + file, 'wb') as f:
                        filename = 'RETR ' + file
                        ftp.retrbinary(filename, f.write)
                except IOError:
                    print("Error:对 {} 下的程序文件更新失败，请调查 ".format(path))
    except IOError:
        print("ftp下载失败")
    else:
        print("{}通讯更新完毕".format(path))


ftp = FTP('30.0.0.2')
ftp.login('deploy','deploy!@#456')
print(ftp.getwelcome())
scan_dir(TargetDir)
file_rename(Path)
ftp.cwd('deploy')
root_list = ftp.nlst()

if 'Com' in root_list:
    ftp.cwd('Com')
    for p in Path:
        download_file(p, ftp.nlst())
    print("ALL Done finished")

ftp.quit()
